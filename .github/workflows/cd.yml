name: CD

on:
  workflow_run:
    workflows: ['CI']
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual trigger'

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    name: Deploy to Production
    runs-on: ubuntu-24.04
    concurrency:
      group: production_environment
      cancel-in-progress: false
    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          command_timeout: '5m'
          script: |
            set -e
            echo "ğŸ”„ Starting deployment process at $(date)"

            if ! command -v docker compose &> /dev/null; then
                echo "ğŸš¨ Docker Compose is not installed. Please install it before running this script."
                exit 1
            fi

            cd ~/discord-bot

            echo "ğŸ“¥ Pulling latest code from repository..."
            git fetch --all
            git reset --hard origin/main

            echo "ğŸ“‹ Changes in this deployment:"
            git log -1 --pretty=format:"%h - %an: %s"

            echo "ğŸ›‘ Stopping current containers..."
            docker compose down

            echo "ğŸ³ Rebuilding and restarting containers..."
            docker compose up --build -d

            echo "âœ… Checking container status..."
            docker compose ps

            echo "ğŸ“œ Checking logs for errors..."
            docker compose logs --tail=50

            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -f

            echo "ğŸš€ Deployment completed successfully at $(date)"
